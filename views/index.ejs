<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Monoton&family=Press+Start+2P&display=swap" rel="stylesheet">
    <title>YouTube To Mp3 Converter</title>
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
</head>
<body>
    <div class="top-container">
        <div id="converter-form">
            <h1>YouTube To Mp3 Converter</h1>
            <h4 style="font-family: 'Press Start 2P', monospace;">Enter Video ID</h4>
            
            <div class="form-group">
                <input type="text" id="videoId" placeholder="Enter Video ID" required>
                <label for="audioEffect">Audio style:</label>
                <select id="audioEffect">
                    <option value="normal" selected>Normal</option>
                    <option value="sped_up">Sped up</option>
                    <option value="hq_8D">8D Audio</option>
                    <option value="slow_reverb">Slowed + Reverb</option>
                </select>
                <button id="convert-btn" onclick="startConversion()">Convert</button>
            </div>
        </div>
    </div>

    <div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: rgba(0,0,0,0.9); z-index: 9999; align-items: center; justify-content: center; flex-direction: column;">
        <lottie-player 
            src="/UkuleleLoading.json" 
            background="transparent" 
            speed="1" 
            style="width: 300px; height: 300px;" 
            loop 
            autoplay>
        </lottie-player>
        <p id="loading-msg" style="color: white; font-family: 'Press Start 2P', monospace; margin-top: 20px; text-align: center;">Preparing Request...</p>
        <p id="countdown" style="color: #ff4757; font-family: 'Press Start 2P', monospace; font-size: 18px; margin-top: 15px;"></p>
    </div>

    <div class="bottom-container" id="results">
        </div> 

    <script>
        async function startConversion() {
            const vid = document.getElementById('videoId').value;
            const effect = document.getElementById('audioEffect').value;
            const overlay = document.getElementById('loadingOverlay');
            const msg = document.getElementById('loading-msg');
            const countdownEl = document.getElementById('countdown');
            const results = document.getElementById('results');

            if (!vid) return alert("Please enter a Video ID!");

            // Show overlay and clear previous results
            overlay.style.setProperty('display', 'flex', 'important');
            results.innerHTML = '';
            msg.innerText = "Fetching download link from API...";

            try {
                // STEP 1: Get the link from backend
                const res1 = await fetch('/get-link', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ videoId: vid })
                });
                const data1 = await res1.json();
                if (!data1.success) throw new Error(data1.message);

                // STEP 2: Client-side 60s Wait (Bypasses Vercel 10s Timeout)
                let timeLeft = 60;
                msg.innerText = "API is generating the file. Please wait...";
                
                const timer = setInterval(async () => {
                    timeLeft--;
                    countdownEl.innerText = `${timeLeft}s remaining`;

                    if (timeLeft <= 0) {
                        clearInterval(timer);
                        countdownEl.innerText = "";
                        msg.innerText = "Applying Audio Effects with FFmpeg...";
                        
                        // STEP 3: Request backend to apply effects
                        await applyAudioEffects(data1.downloadUrl, effect, data1.videoTitle);
                    }
                }, 1000);

            } catch (err) {
                overlay.style.display = 'none';
                results.innerHTML = `<div class="error"><p>Error: ${err.message}</p></div>`;
            }
        }

        async function applyAudioEffects(downloadUrl, effect, videoTitle) {
            const results = document.getElementById('results');
            const overlay = document.getElementById('loadingOverlay');

            try {
                const res2 = await fetch('/apply-effect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ downloadUrl, effect, videoTitle })
                });
                const data2 = await res2.json();
                if (!data2.success) throw new Error(data2.message);

                // Final Success State
                overlay.style.display = 'none';
                
                // Encode title to handle special characters in the URL safely
                const encodedTitle = encodeURIComponent(data2.song_title);

                results.innerHTML = `
                    <div class="success">
                        <p style="color: white; font-family: 'Press Start 2P'; margin-bottom: 15px;">
                            SUCCESS: ${data2.song_title}
                        </p>
                        <a href="/download/${data2.tempFilename}?title=${encodedTitle}">
                            <button class="download-btn">DOWNLOAD MP3</button>
                        </a>
                        <button onclick="location.reload()" style="margin-top: 10px; background: none; border: 1px solid white; color: white; cursor: pointer;">Convert Another</button>
                    </div>
                `;
            } catch (err) {
                overlay.style.display = 'none';
                results.innerHTML = `<div class="error"><p>Processing Error: ${err.message}</p></div>`;
            }
        }
    </script>
</body>
</html>